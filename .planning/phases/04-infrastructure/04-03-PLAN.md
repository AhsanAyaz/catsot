---
phase: 04-infrastructure
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - part2/face-reactive/DEPLOY.md
  - part2/camera-game/DEPLOY.md
  - part2/custom/DEPLOY.md
  - firebase.json
  - .firebaserc.example
  - infrastructure/DEPLOYMENT-GUIDE.md
autonomous: false

must_haves:
  truths:
    - "One-click deploy to Firebase works from command line"
    - "Deployment documentation exists for all three project paths"
    - "Firebase emulator runs locally for offline development"
    - "Deployed projects are accessible via shareable URLs"
  artifacts:
    - path: "firebase.json"
      provides: "Firebase hosting and emulator configuration"
      contains: "hosting"
    - path: "part2/face-reactive/DEPLOY.md"
      provides: "Deployment instructions for face-reactive project"
      min_lines: 40
    - path: "infrastructure/DEPLOYMENT-GUIDE.md"
      provides: "Master deployment guide for workshop facilitator"
      min_lines: 80
  key_links:
    - from: "firebase.json"
      to: "part2/*/public/"
      via: "hosting.public configuration"
      pattern: "\"public\".*part2"
    - from: "DEPLOY.md files"
      to: "firebase deploy command"
      via: "deployment instructions"
      pattern: "firebase deploy"
---

<objective>
Create comprehensive Firebase deployment documentation and test one-click deploy workflow for workshop projects.

Purpose: Attendees must be able to deploy their projects to Firebase Hosting and get shareable URLs by the end of the workshop. Clear documentation and tested deployment path ensure smooth delivery of DELIV-01 requirement.

Output: Deployment guides for each project path, tested firebase.json configuration, and facilitator master guide with troubleshooting.
</objective>

<execution_context>
@/home/ahsan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ahsan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/ahsan/projects/code-at-speed-of-thought/.planning/PROJECT.md
@/home/ahsan/projects/code-at-speed-of-thought/.planning/ROADMAP.md
@/home/ahsan/projects/code-at-speed-of-thought/.planning/STATE.md
@/home/ahsan/projects/code-at-speed-of-thought/.planning/phases/04-infrastructure/04-RESEARCH.md
@/home/ahsan/projects/code-at-speed-of-thought/part2/camera-game/firebase.json
</context>

<tasks>

<task type="auto">
  <name>Create master firebase.json with hosting configuration</name>
  <files>
    firebase.json
    .firebaserc.example
  </files>
  <action>
Create root-level firebase.json for Firebase Hosting deployment of all workshop projects. Extend existing emulator configuration from part2/camera-game/firebase.json.

firebase.json structure:
```json
{
  "hosting": [
    {
      "target": "face-reactive-starter",
      "public": "part2/face-reactive/starter",
      "ignore": [
        "firebase.json",
        "**/.*",
        "**/node_modules/**",
        "**/README.md"
      ],
      "rewrites": [
        {
          "source": "**",
          "destination": "/index.html"
        }
      ]
    },
    {
      "target": "face-reactive-reference",
      "public": "part2/face-reactive/reference",
      "ignore": ["firebase.json", "**/.*", "**/node_modules/**", "**/README.md"]
    },
    {
      "target": "camera-game-starter",
      "public": "part2/camera-game/starter",
      "ignore": ["firebase.json", "**/.*", "**/node_modules/**", "**/README.md"]
    },
    {
      "target": "camera-game-reference",
      "public": "part2/camera-game/reference",
      "ignore": ["firebase.json", "**/.*", "**/node_modules/**", "**/README.md"]
    },
    {
      "target": "custom-template",
      "public": "part2/custom/template",
      "ignore": ["firebase.json", "**/.*", "**/node_modules/**", "**/README.md"]
    }
  ],
  "emulators": {
    "database": {
      "port": 9000
    },
    "hosting": {
      "port": 5000
    },
    "ui": {
      "enabled": true,
      "port": 4000
    }
  }
}
```

Create .firebaserc.example for project configuration:
```json
{
  "projects": {
    "default": "workshop-project-id"
  },
  "targets": {
    "workshop-project-id": {
      "hosting": {
        "face-reactive-starter": [
          "workshop-face-reactive-starter"
        ],
        "face-reactive-reference": [
          "workshop-face-reactive-reference"
        ],
        "camera-game-starter": [
          "workshop-camera-game-starter"
        ],
        "camera-game-reference": [
          "workshop-camera-game-reference"
        ],
        "custom-template": [
          "workshop-custom-template"
        ]
      }
    }
  }
}
```

Add comments explaining:
- Multiple hosting targets for different project variants
- Emulator ports for local development (database: 9000, hosting: 5000, UI: 4000)
- SPA rewrites for face-reactive (all routes → index.html)
- .firebaserc should be copied and customized per workshop instance
  </action>
  <verify>
cat firebase.json shows hosting array with 5 targets and emulators configuration. cat .firebaserc.example shows project structure with hosting targets.
  </verify>
  <done>
Master Firebase configuration exists for deploying all workshop projects with separate hosting targets.
  </done>
</task>

<task type="auto">
  <name>Create deployment guides for each project path</name>
  <files>
    part2/face-reactive/DEPLOY.md
    part2/camera-game/DEPLOY.md
    part2/custom/DEPLOY.md
  </files>
  <action>
Create DEPLOY.md in each project path with step-by-step deployment instructions tailored to that project's needs.

Template structure for all DEPLOY.md files:

```markdown
# Deploying [Project Name] to Firebase

## Prerequisites

- Firebase CLI installed: `npm install -g firebase-tools`
- Google account (free tier works)
- Firebase project created (or use workshop shared project)

## Quick Deploy (5 minutes)

### 1. Login to Firebase

\`\`\`bash
firebase login
\`\`\`

Opens browser for Google account authentication.

### 2. Initialize Firebase (first time only)

\`\`\`bash
# From repository root
firebase init hosting
\`\`\`

- Select: Create a new project or use existing
- Public directory: `part2/[project-path]/starter` (or `reference`)
- Single-page app: [Yes for face-reactive, No for others]
- GitHub deployment: No (optional for future)

### 3. Deploy

\`\`\`bash
firebase deploy --only hosting:[target-name]
\`\`\`

Expected output:
\`\`\`
✔  Deploy complete!

Project Console: https://console.firebase.google.com/project/[project-id]/overview
Hosting URL: https://[project-id].web.app
\`\`\`

### 4. Share Your Project

Copy the Hosting URL and share with participants!

## Local Testing Before Deploy

Test your project locally with Firebase Emulator:

\`\`\`bash
firebase emulators:start --only hosting
\`\`\`

Visit: http://localhost:5000

## Troubleshooting

**"Firebase command not found"**
- Install: `npm install -g firebase-tools`
- Verify: `firebase --version`

**"Permission denied"**
- Run: `firebase login` again
- Check: You have Owner/Editor role on Firebase project

**"Deployment fails with hosting errors"**
- Verify: Public directory path is correct (part2/[path]/starter)
- Check: index.html exists in public directory
- Clear: `firebase deploy --only hosting:[target] --force`

**"Deployed site shows 404"**
- Check: All dependencies (JS/CSS/images) use relative paths
- Verify: CDN fallback paths are correct (/backup/libs/ not ../backup/libs/)
- Test: `firebase emulators:start` first to catch path issues

[Project-specific notes - see individual files below]
```

**Face-reactive specific additions:**
- MediaPipe model download note: "First load may be slow (~8MB model download). Subsequent loads cached by browser."
- Camera permissions: "HTTPS required for camera access. Firebase Hosting provides HTTPS automatically."
- SPA rewrite rule: "All routes redirect to index.html - correct behavior for single-page app."

**Camera-game specific additions:**
- Firebase Realtime Database: "Emulator for local, production DB for deployed. Update firebase.js config with production credentials."
- QR code generation: "Generate session QR codes with: https://[project-id].web.app?session=[code]"
- Multiplayer testing: "Share URL with 2+ friends to test multiplayer. Emulator only works on local network."

**Custom project specific additions:**
- Template deployment: "This is a blank template. Build your project first, then deploy."
- Helper modules: "Verify camera.js, firebase.js work on deployed site (test camera permissions)."
- Example ideas: "See EXAMPLES.md for 15 project ideas to build before deploying."
  </action>
  <verify>
cat part2/face-reactive/DEPLOY.md shows prerequisites, quick deploy steps, local testing, and face-reactive specific notes. cat part2/camera-game/DEPLOY.md shows camera-game specific Firebase DB config. cat part2/custom/DEPLOY.md shows template-specific guidance.
  </verify>
  <done>
Each project path has tailored deployment documentation with project-specific troubleshooting and configuration notes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Firebase deployment configuration and documentation for all three workshop project paths. Includes:
- Root firebase.json with 5 hosting targets (starter/reference for each path)
- Project-specific DEPLOY.md guides with prerequisites, quick deploy, troubleshooting
- Master DEPLOYMENT-GUIDE.md for workshop facilitators
- CDN fallback patterns from 04-01 integrated into deployment workflow
- API quota monitoring from 04-02 documented in deployment context
  </what-built>
  <how-to-verify>
1. **Test deployment workflow (choose one project path):**
   ```bash
   # Install Firebase CLI if not already installed
   npm install -g firebase-tools

   # Login to Firebase
   firebase login

   # Deploy face-reactive starter
   firebase deploy --only hosting:face-reactive-starter
   ```

   Expected: Deployment succeeds, provides hosting URL like `https://workshop-face-reactive-starter.web.app`

2. **Verify deployed site functionality:**
   - Visit the hosting URL in browser
   - Check browser console for errors (should show CDN loads or fallback messages)
   - Test camera permissions (for face-reactive: allow camera, see video feed)
   - Verify MediaPipe model loads (~8MB download, may take 10-20 seconds first time)
   - Check that project works identically to local version

3. **Test local emulator workflow:**
   ```bash
   firebase emulators:start --only hosting
   ```
   Expected: Hosting emulator starts on http://localhost:5000, project accessible

4. **Verify documentation completeness:**
   - Read part2/face-reactive/DEPLOY.md - clear enough for attendees to follow solo?
   - Check troubleshooting section - covers common errors (404, camera permissions)?
   - Confirm project-specific notes match actual deployment behavior

5. **Check deployment readiness for workshop:**
   - Are deployment steps achievable in 5-10 minutes during workshop?
   - Can attendees deploy without facilitator intervention?
   - Are error messages clear enough for self-service debugging?

**Success indicators:**
- ✅ Deployed site loads without errors
- ✅ Camera/API features work on deployed site (not just localhost)
- ✅ DEPLOY.md instructions are accurate and complete
- ✅ Deployment takes <10 minutes from login to shareable URL

**Common issues to watch for:**
- ❌ CDN fallback paths broken (absolute vs relative path issues)
- ❌ Camera permissions blocked on HTTPS (Firebase should provide HTTPS automatically)
- ❌ MediaPipe model 404 (check CDN version in index.html matches backup)
- ❌ Firebase database connection fails (need production config, not emulator)
  </how-to-verify>
  <resume-signal>
Type "approved" if deployment works end-to-end, or describe issues found for fixing.
  </resume-signal>
</task>

<task type="auto">
  <name>Create master deployment guide for facilitators</name>
  <files>
    infrastructure/DEPLOYMENT-GUIDE.md
  </files>
  <action>
Create comprehensive facilitator guide for workshop deployment setup and troubleshooting.

infrastructure/DEPLOYMENT-GUIDE.md structure:

```markdown
# Workshop Deployment Guide for Facilitators

## Pre-Workshop Setup (1 week before)

### 1. Create Firebase Project

1. Visit [Firebase Console](https://console.firebase.google.com/)
2. Click "Add project"
3. Name: "code-speed-thought-workshop-[date]"
4. Disable Google Analytics (not needed for workshop)
5. Note project ID (e.g., `workshop-stockholm-20260128`)

### 2. Configure Firebase Hosting

\`\`\`bash
firebase init hosting
\`\`\`

- Project: Select the workshop project created above
- Public directory: `part2/face-reactive/starter` (we'll add others via firebase.json)
- Single-page app: Yes (for face-reactive)
- GitHub deployment: No

Edit firebase.json to add all 5 hosting targets (already done - verify configuration).

### 3. Set Up Hosting Targets

\`\`\`bash
firebase target:apply hosting face-reactive-starter workshop-face-reactive-starter
firebase target:apply hosting face-reactive-reference workshop-face-reactive-reference
firebase target:apply hosting camera-game-starter workshop-camera-game-starter
firebase target:apply hosting camera-game-reference workshop-camera-game-reference
firebase target:apply hosting custom-template workshop-custom-template
\`\`\`

Verify: `cat .firebaserc` shows all targets configured

### 4. Deploy Reference Implementations

\`\`\`bash
firebase deploy --only hosting:face-reactive-reference
firebase deploy --only hosting:camera-game-reference
firebase deploy --only hosting:custom-template
\`\`\`

Save URLs for demo during workshop.

### 5. Enable Firebase Realtime Database (for camera-game)

1. Firebase Console → Realtime Database
2. Create database (test mode for workshop)
3. Copy database URL: `https://[project-id]-default-rtdb.firebaseio.com`
4. Update part2/camera-game/*/src/multiplayer.js with production config:

\`\`\`javascript
const firebaseConfig = window.location.hostname === 'localhost'
  ? { databaseURL: "http://127.0.0.1:9000?ns=workshop-demo" }
  : {
      apiKey: "[from Firebase Console]",
      authDomain: "[project-id].firebaseapp.com",
      databaseURL: "https://[project-id]-default-rtdb.firebaseio.com",
      projectId: "[project-id]",
      storageBucket: "[project-id].appspot.com",
      messagingSenderId: "[from Firebase Console]",
      appId: "[from Firebase Console]"
    };
\`\`\`

5. Deploy updated camera-game reference:
\`\`\`bash
firebase deploy --only hosting:camera-game-reference
\`\`\`

## During Workshop

### Attendee Deployment Workflow

**Option A: Individual Firebase Projects (Recommended)**

Each attendee creates their own Firebase project:
- Pros: Full ownership, can modify after workshop
- Cons: Requires Google account, 5 min setup time

Instructions: See part2/[project]/DEPLOY.md

**Option B: Shared Workshop Project**

All attendees deploy to workshop project with different site names:
- Pros: No account creation, faster setup
- Cons: Attendees can't modify after workshop, quota shared

Setup:
1. Add attendees as Editors to workshop Firebase project
2. Each attendee deploys to unique target: `firebase deploy --only hosting:attendee-[name]`

**Recommendation:** Use Option A for small workshops (<20 people), Option B for larger.

### Common Deployment Issues

**Issue: "Firebase command not found"**
- Solution: `npm install -g firebase-tools` (requires Node.js)
- Backup: Use Firebase Studio (browser-based, no CLI needed)

**Issue: "Permission denied" during deploy**
- Solution: `firebase login` and select correct Google account
- Verify: User has Editor role on project

**Issue: Deployed site shows blank page**
- Check: Browser console for errors (F12 → Console tab)
- Common: CDN blocked, MediaPipe model 404, Firebase config missing
- Test: `firebase emulators:start` locally first

**Issue: Camera not working on deployed site**
- Verify: Site uses HTTPS (Firebase Hosting provides this automatically)
- Check: Browser camera permissions granted
- Test: Visit site in incognito mode (clean permissions state)

**Issue: Multiplayer not syncing (camera-game)**
- Verify: Firebase Realtime Database created and config updated
- Check: Database rules allow read/write (test mode)
- Test: Open site in 2 browser tabs, verify data syncs

**Issue: Gemini API quota exhausted**
- Solution: Use backup keys from 04-02 quota monitoring
- Check: infrastructure/SETUP.md for multi-key configuration
- Backup: Use offline mock (backup/mocks/gemini-api-mock.js)

### Monitoring During Workshop

**Firebase Console Dashboard:**
- Hosting: Monitor request volume, bandwidth
- Realtime Database: Monitor concurrent connections, storage
- Quotas: Check for approaching limits

**Expected Workshop Load:**
- 40 participants × 1 deployment = 40 hosting sites
- Camera-game: 10-15 concurrent multiplayer sessions
- Gemini API: 500-800 total requests across all attendees

**Quota Limits (Free Tier):**
- Hosting: 10 GB bandwidth/month (workshop uses ~500 MB)
- Realtime Database: 100 concurrent connections (workshop uses 20-30)
- Gemini API: 15 RPM/key (3 keys = 45 RPM, sufficient)

## Post-Workshop

### Attendee Access

**Individual projects:** Attendees retain full ownership
- They can deploy updates indefinitely
- No action needed from facilitator

**Shared project:** Export attendee sites before deletion
- Download: `firebase hosting:clone [source-site] [dest-site]`
- Share: Provide ZIP of deployed files to attendees

### Cleanup

1. Download workshop project for archival:
   \`\`\`bash
   firebase hosting:clone workshop-face-reactive-reference ./archive/
   \`\`\`

2. (Optional) Delete workshop Firebase project:
   - Firebase Console → Project Settings → Delete Project
   - Confirm deletion (irreversible)

3. Share final workshop materials:
   - GitHub repo: https://github.com/[user]/code-at-speed-of-thought
   - Deployed references: List all reference URLs
   - Cheatsheet PDF: materials/cheatsheet.pdf
   - Slide deck: materials/slides.pdf

## Troubleshooting Reference

| Symptom | Diagnosis | Fix |
|---------|-----------|-----|
| Blank deployed page | Path error | Check public directory in firebase.json |
| Camera permission denied | HTTPS missing | Verify Firebase Hosting URL starts with https:// |
| MediaPipe 404 | CDN version mismatch | Check index.html uses 0.10.15 (not 0.10.16+) |
| Firebase DB not syncing | Config missing | Update multiplayer.js with production config |
| Gemini API 429 errors | Quota exhausted | Switch to backup key or offline mock |
| Deploy command hangs | Network issue | Check WiFi, try `firebase deploy --debug` |
| Multiple 404s on deploy | Relative paths | Use absolute paths (/backup/libs/ not ../backup/) |

## Workshop Venue Network Considerations

**Test before workshop day:**
1. Verify Firebase CLI works on venue WiFi
2. Check if CDNs accessible (unpkg.com, cdn.jsdelivr.net, gstatic.com)
3. Test camera permissions on venue network (some corporate WiFi blocks WebRTC)
4. Confirm Firebase Hosting deploy speed (should be <2 min per site)

**Backup plan:**
- Mobile hotspot for facilitator (bypass corporate network restrictions)
- Pre-deployed reference implementations (offline QR codes for URLs)
- Local emulator-only workshop (no deployment, export ZIP files)
```
  </action>
  <verify>
cat infrastructure/DEPLOYMENT-GUIDE.md shows pre-workshop setup (7 steps), during-workshop guidance (deployment options, common issues), post-workshop cleanup, and troubleshooting reference table.
  </verify>
  <done>
Master deployment guide exists with complete facilitator instructions for workshop setup, execution, and troubleshooting.
  </done>
</task>

</tasks>

<verification>
End-to-end deployment verification checklist:
- [ ] Firebase CLI installed and authenticated
- [ ] firebase.json contains all 5 hosting targets
- [ ] .firebaserc configured with project ID and targets
- [ ] At least one project deployed successfully (test with face-reactive-starter)
- [ ] Deployed URL accessible and project loads without errors
- [ ] Camera permissions work on deployed HTTPS site
- [ ] CDN dependencies load (or fallback to local copies)
- [ ] DEPLOY.md guides are accurate for each project
- [ ] DEPLOYMENT-GUIDE.md covers facilitator pre/during/post workshop needs
- [ ] Firebase emulator works for local testing
</verification>

<success_criteria>
- [ ] Firebase configuration supports deploying all 5 project variants (3 paths × starter/reference)
- [ ] One-click deploy works: `firebase deploy --only hosting:[target]` completes in <5 minutes
- [ ] Deployed projects are accessible via shareable URLs (https://[project-id].web.app format)
- [ ] DEPLOY.md exists for all three project paths with troubleshooting
- [ ] DEPLOYMENT-GUIDE.md exists for workshop facilitators with pre/during/post-workshop instructions
- [ ] Human verification confirms deployment workflow works end-to-end
- [ ] Local emulator works for offline development and testing
</success_criteria>

<output>
After completion, create `.planning/phases/04-infrastructure/04-03-SUMMARY.md`
</output>
