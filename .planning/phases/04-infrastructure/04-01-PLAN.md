---
phase: 04-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - part2/face-reactive/starter/index.html
  - part2/face-reactive/reference/index.html
  - part2/camera-game/starter/index.html
  - part2/camera-game/reference/index.html
  - part2/custom/template/index.html
  - backup/libs/html5-qrcode.min.js
  - backup/libs/mediapipe-vision-bundle.js
  - backup/mocks/gemini-api-mock.js
autonomous: true

must_haves:
  truths:
    - "Projects load CDN dependencies successfully when online"
    - "Projects fall back to local copies when CDN fails"
    - "Gemini API mock returns realistic responses when offline"
    - "Workshop continues without internet for offline development"
  artifacts:
    - path: "backup/libs/html5-qrcode.min.js"
      provides: "Local copy of QR scanning library"
      min_lines: 100
    - path: "backup/libs/mediapipe-vision-bundle.js"
      provides: "Local copy of MediaPipe library"
      min_lines: 100
    - path: "backup/mocks/gemini-api-mock.js"
      provides: "Offline Gemini API mock with realistic responses"
      min_lines: 50
    - path: "part2/face-reactive/starter/index.html"
      provides: "CDN fallback pattern for MediaPipe"
      contains: "window.FaceLandmarker || document.write"
    - path: "part2/camera-game/starter/index.html"
      provides: "CDN fallback pattern for html5-qrcode"
      contains: "window.Html5Qrcode || document.write"
  key_links:
    - from: "part2/*/index.html"
      to: "backup/libs/*.js"
      via: "CDN fallback script tags"
      pattern: "document\\.write.*backup/libs"
    - from: "modules/*/solutions/*.js"
      to: "backup/mocks/gemini-api-mock.js"
      via: "API endpoint detection"
      pattern: "localhost.*gemini-api-mock"
---

<objective>
Create offline fallback infrastructure for workshop resilience against CDN failures and API quota exhaustion.

Purpose: Ensure the workshop can continue even with unreliable WiFi or blocked CDNs. Attendees should be able to develop and test locally without internet dependency after initial page load.

Output: CDN fallback patterns in all project HTML files, local copies of critical libraries (html5-qrcode, MediaPipe), and Gemini API mock for offline development.
</objective>

<execution_context>
@/home/ahsan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ahsan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/ahsan/projects/code-at-speed-of-thought/.planning/PROJECT.md
@/home/ahsan/projects/code-at-speed-of-thought/.planning/ROADMAP.md
@/home/ahsan/projects/code-at-speed-of-thought/.planning/STATE.md
@/home/ahsan/projects/code-at-speed-of-thought/.planning/phases/04-infrastructure/04-RESEARCH.md
@/home/ahsan/projects/code-at-speed-of-thought/part2/face-reactive/starter/index.html
@/home/ahsan/projects/code-at-speed-of-thought/part2/camera-game/starter/index.html
</context>

<tasks>

<task type="auto">
  <name>Download and bundle CDN dependencies locally</name>
  <files>
    backup/libs/html5-qrcode.min.js
    backup/libs/mediapipe-vision-bundle.js
    backup/libs/firebase-app.js
    backup/libs/firebase-database.js
  </files>
  <action>
Create backup/libs/ directory structure. Download production-ready copies of critical CDN dependencies:

1. html5-qrcode v2.3.8 from unpkg.com:
   - URL: https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js
   - Used by camera-game project for QR scanning
   - File size: ~50KB minified

2. MediaPipe Tasks Vision v0.10.15 bundle from jsDelivr:
   - URL: https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.15/vision_bundle.js
   - Used by face-reactive project for face detection
   - Note: Use 0.10.15 not 0.10.16+ (research flagged missing wasm files in newer versions)
   - File size: ~200KB

3. Firebase modular SDK v10.7.1:
   - firebase-app.js from https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js
   - firebase-database.js from https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js
   - Used by camera-game for multiplayer state sync

Use curl or wget to download. Verify file integrity (check file sizes match expected). Add README.md in backup/libs/ documenting source URLs and versions.

DO NOT modify minified files. These are production builds, not development sources.
  </action>
  <verify>
ls -lh backup/libs/ shows all 4 files exist with reasonable sizes (html5-qrcode ~50KB, mediapipe ~200KB, firebase files ~30KB each). cat backup/libs/README.md shows source URLs and download date.
  </verify>
  <done>
All CDN dependencies downloaded and verified in backup/libs/ with documentation of sources and versions.
  </done>
</task>

<task type="auto">
  <name>Implement CDN fallback pattern in project HTML files</name>
  <files>
    part2/face-reactive/starter/index.html
    part2/face-reactive/reference/index.html
    part2/camera-game/starter/index.html
    part2/camera-game/reference/index.html
    part2/custom/template/index.html
  </files>
  <action>
Add CDN fallback script loading pattern to all Part 2 project HTML files following research Pattern 1 (CDN with Local Fallback).

For face-reactive projects (uses MediaPipe):
```html
<!-- MediaPipe from CDN -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.15/vision_bundle.js"></script>
<!-- Fallback to local copy if CDN fails -->
<script>
  window.FaceLandmarker || document.write('<script src="/backup/libs/mediapipe-vision-bundle.js"><\/script>');
</script>
```

For camera-game projects (uses html5-qrcode):
```html
<!-- html5-qrcode from CDN -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Fallback to local copy if CDN fails -->
<script>
  window.Html5Qrcode || document.write('<script src="/backup/libs/html5-qrcode.min.js"><\/script>');
</script>
```

For Firebase SDK (ES modules - different pattern):
Use try/catch in main.js to detect import failure and show helpful error message pointing to emulator setup or local fallback.

Add HTML comment explaining pattern: "<!-- CDN with automatic fallback: loads from CDN first, falls back to /backup/libs/ if CDN blocked/slow/down -->"

Apply to both starter and reference implementations. Custom template should include commented examples of both patterns.
  </action>
  <verify>
grep -r "document\.write.*backup/libs" part2/*/index.html shows fallback patterns in all 5 files. grep -r "window\.Html5Qrcode\|window\.FaceLandmarker" part2/*/index.html confirms detection checks exist.
  </verify>
  <done>
All project HTML files implement CDN fallback pattern. Projects will automatically use local copies if CDN unavailable.
  </done>
</task>

<task type="auto">
  <name>Create Gemini API offline mock for development</name>
  <files>
    backup/mocks/gemini-api-mock.js
    backup/mocks/README.md
  </files>
  <action>
Create lightweight Gemini API mock that returns realistic responses for offline development and testing.

Structure:
```javascript
// backup/mocks/gemini-api-mock.js
// Offline mock for Gemini API - returns realistic responses without network calls
// Usage: Replace API endpoint with http://localhost:3000/mock when offline

const mockResponses = {
  'recipe': {
    candidates: [{
      content: {
        parts: [{ text: JSON.stringify({
          name: "Swedish Meatballs",
          ingredients: ["beef", "breadcrumbs", "egg", "cream"],
          steps: ["Mix ingredients", "Form balls", "Cook in pan"],
          servings: 4
        })}]
      }
    }]
  },
  'emotion': {
    candidates: [{
      content: {
        parts: [{ text: JSON.stringify({
          emotion: "happy",
          confidence: 0.85,
          description: "The person appears cheerful and engaged"
        })}]
      }
    }]
  },
  'default': {
    candidates: [{
      content: {
        parts: [{ text: "Mock response from offline Gemini API. Real API unavailable." }]
      }
    }]
  }
};

// Simple HTTP server (Node.js) or static response mapper
function getMockResponse(prompt) {
  if (prompt.includes('recipe') || prompt.includes('ingredient')) return mockResponses.recipe;
  if (prompt.includes('emotion') || prompt.includes('feeling')) return mockResponses.emotion;
  return mockResponses.default;
}

// Export for both Node.js and browser
if (typeof module !== 'undefined') module.exports = { getMockResponse };
```

Add README.md in backup/mocks/ explaining:
- When to use mock (offline development, API quota exhausted)
- How to use mock (replace API endpoint, or use feature flag)
- What responses are available (recipe, emotion, default)
- Limitations (no real AI, static responses only)

Include usage example showing environment detection:
```javascript
const API_ENDPOINT = navigator.onLine && !OFFLINE_MODE
  ? 'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent'
  : '/backup/mocks/gemini-api-mock.js';
```
  </action>
  <verify>
cat backup/mocks/gemini-api-mock.js shows mock responses for recipe, emotion, and default cases. cat backup/mocks/README.md explains usage and limitations.
  </verify>
  <done>
Gemini API mock exists with realistic responses for common workshop scenarios. Developers can continue working offline after API quota exhaustion.
  </done>
</task>

</tasks>

<verification>
Test offline fallback behavior:
1. Disconnect from internet (airplane mode or network off)
2. Load part2/face-reactive/starter/index.html - should load MediaPipe from backup/libs/
3. Load part2/camera-game/starter/index.html - should load html5-qrcode from backup/libs/
4. Check browser console for fallback messages
5. Verify no CDN-related errors in console

Test Gemini API mock:
1. Import backup/mocks/gemini-api-mock.js in test script
2. Call getMockResponse with various prompts
3. Verify recipe/emotion/default responses return correctly
</verification>

<success_criteria>
- [ ] backup/libs/ directory contains 4 CDN dependencies (html5-qrcode, MediaPipe, Firebase SDK files)
- [ ] All 5 Part 2 project HTML files implement CDN fallback pattern
- [ ] Gemini API mock returns realistic responses for recipe, emotion, and default prompts
- [ ] Projects load successfully offline (after initial CDN download or using local copies)
- [ ] No CDN-related console errors when internet disconnected
</success_criteria>

<output>
After completion, create `.planning/phases/04-infrastructure/04-01-SUMMARY.md`
</output>
